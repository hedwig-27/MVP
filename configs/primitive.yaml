model:
  type: composite
  cond:
    use_dataset_embed: false
  base_operator:
    enabled: true
    type: fno
    modes: 16
    width: 64
    depth: 4
    fc_dim: 128
    kernel_size: 5
  term_library:
    enabled: true
    hidden_dim: 32
    use_scale_mlp: true
  residual:
    num_experts: 4
    type: fno
    modes: 8
    width: 32
    depth: 3
    fc_dim: 64
    kernel_size: 5
  router:
    type: transformer
    d_model: 64
    n_layers: 2
    n_heads: 4
    ff_dim: 256
    dropout: 0.0
    use_state_tokens: true
    state_downsample: 4
    use_stats_token: true
    use_primitive_queries: true
    hidden_dim: 64
    top_k: 4
    stats: [mean, std, min, max, grad_norm]
    local_segments: 4
    local_stats: [mean, std]
    fft_bins: 8
    pde_param_dim: 4
    dataset_embed_dim: 8
    use_dataset_embed: false
    code_dim: 0
    code_as_weight: false
    spatial: false

data:
  seed: 0
  n_res: 128
  timesteps: 41
  time_downsample: 5
  include_grid: true
  normalize: true
  global_normalize: true
  append_dt_to_params: true
  equation_terms: [advection, nonlinear_advection, diffusion, reaction, sorption, cns]
  equation_text_dim: 128
  n_train: 8000
  n_val: 1000
  n_test: 1000
  batch_size: 32
  num_workers: 4
  sample_ratio: 100
  steps_per_epoch: 1000
  datasets:
    - name: adv_beta0.4
      path: datasets/1D_Advection_Sols_beta0.4.hdf5
      params: {beta: 0.4, nu: 0.0, rho: 0.0}
      equation_coeffs: {advection: 0.4}
      equation_text: '\partial_t u(t,x) + \beta \partial_x u(t,x) = 0, \beta=0.4'
      weight: 1.0
    - name: burgers_nu0.001
      path: datasets/1D_Burgers_Sols_Nu0.001.hdf5
      params: {beta: 0.0, nu: 0.001, rho: 0.0}
      equation_coeffs: {nonlinear_advection: 1.0, diffusion: 0.00031831}
      equation_text: '\partial_t u(t,x) + \partial_x \frac{u(t,x)^2}{2} = \frac{\nu}{\pi} \partial_{xx} u(t,x), \nu=0.001'
      weight: 1.0
    - name: diff_sorp
      path: datasets/1D_diff-sorp_NA_NA.h5
      params: {beta: 0.0, nu: 0.0, rho: 0.0}
      equation_coeffs: {diffusion: 0.0005, sorption: 1.0}
      equation_text: '\partial_t u(t,x) = \frac{D}{R(u)} \partial_{xx} u(t,x), D=5\times10^{-4}'
      timesteps: 21
      time_downsample: 5
      weight: 1.0
  eval_datasets:
    - name: adv_beta1.0
      path: datasets/1D_Advection_Sols_beta1.0.hdf5
      params: {beta: 1.0, nu: 0.0, rho: 0.0}
      equation_coeffs: {advection: 1.0}
      equation_text: '\partial_t u(t,x) + \beta \partial_x u(t,x) = 0, \beta=1.0'
    - name: burgers_nu1
      path: datasets/1D_Burgers_Sols_Nu1.0.hdf5
      params: {beta: 0.0, nu: 1.0, rho: 0.0}
      equation_coeffs: {nonlinear_advection: 1.0, diffusion: 0.31831}
      equation_text: '\partial_t u(t,x) + \partial_x \frac{u(t,x)^2}{2} = \frac{\nu}{\pi} \partial_{xx} u(t,x), \nu=1.0'
  eval_equation_datasets:
    - name: reacdiff_rho1
      path: datasets/ReacDiff_Nu0.5_Rho1.0.hdf5
      params: {beta: 0.0, nu: 0.5, rho: 1.0}
      equation_coeffs: {diffusion: 0.5, reaction: 1.0}
      equation_text: '\partial_t u(t,x) - \nu \partial_{xx} u(t,x) = \rho u(t,x)(1 - u(t,x)), \nu=0.5, \rho=1.0'
      timesteps: 21
      time_downsample: 5
    - name: reacdiff_rho5
      path: datasets/ReacDiff_Nu0.5_Rho5.0.hdf5
      params: {beta: 0.0, nu: 0.5, rho: 5.0}
      equation_coeffs: {diffusion: 0.5, reaction: 5.0}
      equation_text: '\partial_t u(t,x) - \nu \partial_{xx} u(t,x) = \rho u(t,x)(1 - u(t,x)), \nu=0.5, \rho=5.0'
      timesteps: 21
      time_downsample: 5
    - name: reacdiff_rho10
      path: datasets/ReacDiff_Nu0.5_Rho10.0.hdf5
      params: {beta: 0.0, nu: 0.5, rho: 10.0}
      equation_coeffs: {diffusion: 0.5, reaction: 10.0}
      equation_text: '\partial_t u(t,x) - \nu \partial_{xx} u(t,x) = \rho u(t,x)(1 - u(t,x)), \nu=0.5, \rho=10.0'
      timesteps: 21
      time_downsample: 5

training:
  base_pretrain_epochs: 20
  residual_pretrain_epochs: 20
  joint_finetune_epochs: 10
  learning_rate: 0.001
  finetune_lr: 0.0003
  dataset_id_dropout: 0.5
  term_align_weight: 0.1
  load_balance_weight: 0.01
  freeze_best_val_by_dataset: true
  best_val_by_dataset:
    adv_beta0.4: 0.01
    burgers_nu0.001: 0.04
    diff_sorp: 0.002
  output_model: outputs/latest_primitive/primitive_model.pt
